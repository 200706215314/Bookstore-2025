# 书店管理系统BookStore总体设计文档

- 文档作者：王文轩

- 12.12初稿 持续更新

## 程序功能概述

本项目是一个基于C++的命令行书店管理系统，严格遵循《业务要求》和《标准要求》文档规范。系统面向四类用户角色（游客、顾客、销售人员、店长），实现完整的图书销售业务管理功能。


## 主体逻辑说明

```mermaid
graph LR
    subgraph "用户接口层"
        CLI[命令行接口]
        IP[指令解析器]
        OM[输出管理器]
    end
    
    subgraph "业务逻辑层"
        subgraph "核心控制器"
            BS[书店系统控制器]
        end
        
        subgraph "账户管理"
            AM[账户管理器]
            LS[登录栈管理器]
            AV[权限验证器]
        end
        
        subgraph "图书管理"
            BM[图书管理器]
            SM[库存管理器]
            BSG[图书检索器]
        end
        
        subgraph "财务管理"
            FM[财务管理器]
            TM[交易处理器]
            RG[报表生成器]
        end
        
        subgraph "日志管理"
            LM[日志管理器]
            AMA[操作审计器]
            WR[工作报告生成器]
        end
    end
    
    subgraph "数据访问层"
        DAL[数据访问层接口]
        
        subgraph "存储引擎"
            MR[MemoryRiver模板引擎]
            BL[BlockList索引引擎]
        end
        
        subgraph "数据模型"
            UM[用户数据模型]
            BMOD[图书数据模型]
            TMOD[交易数据模型]
            LMOD[日志数据模型]
        end
    end
    
    subgraph "文件存储层"
        FS[文件系统接口]
        UFILE[用户数据文件]
        BFILE[图书数据文件]
        TFILE[交易数据文件]
        LFILE[日志数据文件]
        IFILES[索引文件集合]
    end
    
    subgraph "工具支持层"
        TU[时间工具类]
        SU[字符串工具类]
        EU[错误处理工具]
        VU[验证工具类]
    end
    
    CLI --> IP
    IP --> BS
    BS --> AM
    BS --> BM
    BS --> FM
    BS --> LM
    AM --> DAL
    BM --> DAL
    FM --> DAL
    LM --> DAL
    DAL --> MR
    DAL --> BL
    MR --> FS
    BL --> FS
    FS --> UFILE
    FS --> BFILE
    FS --> TFILE
    FS --> LFILE
    FS --> IFILES
    AM --> AV
    AV --> LS
    BS --> OM
    OM --> CLI
    AM --> TU & SU & EU & VU
    BM --> TU & SU & EU & VU
    FM --> TU & SU & EU & VU
    LM --> TU & SU & EU & VU
```

### 嵌套登陆栈机制

```mermaid
stateDiagram-v2
    [*] --> 游客状态
    游客状态 --> 登录状态: su指令成功
    登录状态 --> 嵌套登录状态: su指令成功
    嵌套登录状态 --> 嵌套登录状态: su指令成功
    嵌套登录状态 --> 登录状态: logout指令
    登录状态 --> 游客状态: logout指令
    游客状态 --> [*]: quit/exit
    登录状态 --> [*]: quit/exit
    嵌套登录状态 --> [*]: quit/exit
```

### 程序执行流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant CLI as 命令行接口
    participant Parser as 指令解析器
    participant Controller as 系统控制器
    participant Validator as 权限验证器
    participant Module as 业务模块
    participant Storage as 存储层
    participant FS as 文件系统

    Note over User,FS: 1. 系统启动
    FS->>Controller: 检查数据文件
    Controller->>FS: 创建必要文件
    Controller->>FS: 创建root账户
    Note over User,FS: 2. 指令处理循环
    loop 指令处理循环
        User->>CLI: 输入指令
        CLI->>Parser: 传递指令字符串
        Parser->>Parser: 解析指令格式
        Parser->>Validator: 验证基础格式
        Validator->>Controller: 传递解析结果
        
        Controller->>Validator: 检查用户权限
        Validator->>Controller: 返回权限验证结果
        
        alt 权限验证通过
            Controller->>Module: 调用对应业务模块
            Module->>Storage: 读写数据操作
            Storage->>FS: 文件I/O操作
            FS->>Storage: 返回文件数据
            Storage->>Module: 返回数据结果
            Module->>Controller: 返回操作结果
            Controller->>CLI: 格式化输出
            CLI->>User: 显示结果
        else 权限验证失败
            Controller->>CLI: 生成错误信息
            CLI->>User: 显示"Invalid"
        end
    end
    Note over User,FS: 3. 系统退出
    User->>CLI: 输入"quit"或"exit"
    CLI->>Controller: 退出指令
    Controller->>FS: 保存必要状态
    Controller->>CLI: 退出程序
```
## 代码文件结构

```plain
bookstore/
├── main.cpp                      # 程序入口点
├── src/                        # 工具类
│   ├── token.cpp
│   ├── people.cpp               # 用户类定义
│   ├── account.cpp       # 登录栈管理
│   ├── book.cpp   # 账户操作逻辑
│   └── log.cpp  
└── include/                     # 账户管理模块
    ├── token.h
    ├── people.h               # 用户类定义
    ├── account.h       # 登录栈管理
    ├── book.h   # 账户操作逻辑
    └── log.h        # 权限控制

```

### 核心类关系图
```mermaid
classDiagram
    class BookstoreSystem {
        -LoginStack login_stack
        -AccountManager account_manager
        -BookManager book_manager
        -FinanceManager finance_manager
        -LogManager log_manager
        +initialize()
        +run()
        +process_command(cmd)
        +shutdown()
    }

    class InstructionParser {
        +ParsedCommand parse(input)
        +bool validate(cmd)
    }

    class AccountManager {
        -MemoryRiver~User~ user_file
        -BlockList user_index
        +register_user()
        +login()
        +logout()
        +modify_password()
        +add_user()
        +delete_user()
    }

    class BookManager {
        -MemoryRiver~Book~ book_file
        -BlockList isbn_index
        -BlockList name_index
        -BlockList author_index
        -BlockList keyword_index
        +add_book()
        +modify_book()
        +search_book()
        +buy_book()
        +import_book()
    }

    class FinanceManager {
        -MemoryRiver~Transaction~ trans_file
        -BlockList trans_time_index
        +record_transaction()
        +query_finance()
        +generate_report()
    }

    class LogManager {
        -MemoryRiver~LogEntry~ log_file
        -BlockList log_time_index
        +record_operation()
        +query_log()
        +generate_employee_report()
        +generate_system_log()
    }

    class MemoryRiver~T~ {
        -fstream file
        -int info_len
        +initialize(filename)
        +write(t) int
        +update(t, pos)
        +read(t, pos)
        +delete(pos)
    }

    class BlockList {
        -MemoryRiver~BlockNode~ file
        -int head
        +insert(index, value)
        +remove(index, value)
        +find(index) vector~int~
        +split_block(block)
        +merge_blocks(block1, block2)
    }

    BookstoreSystem --> InstructionParser
    BookstoreSystem --> AccountManager
    BookstoreSystem --> BookManager
    BookstoreSystem --> FinanceManager
    BookstoreSystem --> LogManager
    AccountManager --> MemoryRiver~User~
    AccountManager --> BlockList
    BookManager --> MemoryRiver~Book~
    BookManager --> BlockList
    FinanceManager --> MemoryRiver~Transaction~
    FinanceManager --> BlockList
    LogManager --> MemoryRiver~LogEntry~
    LogManager --> BlockList
    BlockList --> MemoryRiver~BlockNode~
```

## 数据库设计

class account{ 权限 ID 密码password 用户名 }
class book{ ISBN BookName Author Keyword Quantity Price TotalCost }
class log{ Count }
## 类结构体设计

## 其他补充说明
